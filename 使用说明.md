# 快递代取系统使用说明

## 🚀 快速启动

### Windows用户
1. **双击运行** `run.bat` 文件
2. 按照菜单提示选择操作
3. **推荐选择"5. Full Setup and Start"**（一键完整安装并启动）

### Linux/Mac用户
1. 打开终端，进入项目目录
2. 运行：`chmod +x run.sh`
3. 运行：`./run.sh`
4. 按照菜单提示选择操作

## 📋 系统要求

- **Node.js**: 14.0 或更高版本
- **MySQL**: 8.0 或更高版本
- **npm**: 6.0 或更高版本

## 🔧 安装步骤

### 1. 环境检查
- 检查Node.js是否安装
- 检查MySQL是否安装
- 检查项目文件是否完整

### 2. 安装依赖
- 自动安装后端所需的npm包
- 如果已安装会跳过此步骤

### 3. 数据库初始化
- 输入MySQL root密码
- 自动创建数据库和表结构
- 插入测试数据

### 4. 启动系统
- 配置数据库连接
- 启动后端服务
- **数据库连接成功后自动打开浏览器**

## 🔐 密码处理机制

### 智能密码输入
系统提供了多种密码输入方式：

1. **启动脚本输入**：在启动时输入密码（隐藏显示）
2. **交互式输入**：当连接失败时，系统会提示输入密码（隐藏显示）
3. **环境变量**：设置 `DB_PASSWORD` 环境变量
4. **配置文件**：直接修改数据库配置文件

### 密码安全特性
- **隐藏输入**：所有密码输入都使用PowerShell隐藏显示
- **安全存储**：密码不会保存在代码或日志中
- **临时使用**：密码仅在运行时临时使用
- **自动清理**：临时文件会自动删除
- **备用方案**：如果PowerShell失败，会提示用户注意环境安全

### 交互式密码输入功能
当数据库连接失败时，系统会自动检测错误类型：
- 如果是密码错误，会提示输入密码
- 输入密码后自动重试连接
- 支持无密码的情况（直接按回车）
- **只有在数据库连接成功后才会打开浏览器**
- **连接池会自动更新，确保所有API调用都使用正确的密码**

## 🌐 浏览器打开机制

### 智能浏览器打开
- **连接成功前**：不会打开浏览器，避免显示错误页面
- **连接成功后**：自动打开浏览器访问系统
- **跨平台支持**：Windows、Mac、Linux都支持自动打开
- **延迟打开**：等待2秒确保服务器完全启动

### 浏览器打开时机
1. 数据库连接测试成功
2. 服务器启动完成
3. 等待2秒确保服务稳定
4. 自动打开默认浏览器

## 🔧 技术架构

### 数据库连接池管理
- **动态更新**：密码输入后自动更新连接池配置
- **全局同步**：所有路由都使用最新的连接池
- **错误恢复**：连接失败时自动重试
- **资源管理**：正确关闭旧连接池，避免资源泄漏

### API路由优化
- **实时连接**：每个API调用都获取最新的连接池
- **错误处理**：统一的错误处理和用户提示
- **性能优化**：连接池复用，提高响应速度

### 端口管理
- **自动检测**：自动检测端口是否被占用
- **智能切换**：如果默认端口被占用，自动选择可用端口
- **用户提示**：显示实际使用的端口号
- **范围限制**：在合理范围内查找可用端口（默认端口+100）

## 👤 测试账号

系统提供4个测试账号，可以直接登录使用：

| 用户名 | 密码 | 邮箱 | 手机号 |
|--------|------|------|--------|
| zhangsan | password123 | zhangsan@example.com | 13800138001 |
| lisi | password123 | lisi@example.com | 13800138002 |
| wangwu | password123 | wangwu@example.com | 13800138003 |
| zhaoliu | password123 | zhaoliu@example.com | 13800138004 |

### 注册要求
- **用户名**：3-50个字符
- **密码**：至少6个字符
- **邮箱**：有效的邮箱格式
- **手机号**：11位手机号（1开头）

## 🌐 访问地址

- **前端界面**: http://localhost:3000
- **API接口**: http://localhost:3000/api
- **健康检查**: http://localhost:3000/api/health

## 🔒 安全说明

- 所有密码都是临时输入，不会保存在代码中
- 数据库配置仅在运行时临时创建
- 使用JWT token进行用户认证
- 密码使用bcrypt加密存储
- 交互式密码输入，提高用户体验
- 浏览器只在连接成功后打开，避免错误页面
- 连接池动态更新，确保密码安全

## 🛠️ 常见问题

### 1. 启动失败
- 检查MySQL服务是否启动
- 确认密码输入正确
- 检查端口3000是否被占用（系统会自动选择其他端口）

### 2. 数据库连接失败
- 确认MySQL已安装并启动
- 检查用户名密码是否正确
- 确认有足够的数据库权限
- **新功能**：系统会自动提示输入密码
- **浏览器不会打开**，直到连接成功
- **连接池会自动更新**，确保所有功能正常

### 3. 依赖安装失败
- 检查网络连接
- 尝试使用国内npm镜像
- 删除node_modules重新安装

### 4. 批处理文件编码问题（已修复）
- 新版本使用英文界面，避免编码问题
- 如果仍有问题，可以运行 `test.bat` 进行基础测试

### 5. 密码输入问题
- 如果启动时密码输入失败，系统会在运行时提示输入
- 支持无密码的MySQL配置
- 密码输入错误时会自动重试
- 只有在密码正确连接成功后才会打开浏览器
- **重要修复**：连接池会自动更新，解决API调用时的密码问题
- **安全改进**：交互式密码输入也使用PowerShell隐藏显示

### 6. 浏览器没有自动打开
- 检查是否有防火墙阻止
- 确认默认浏览器设置正确
- 可以手动访问显示的端口地址

### 7. 认证问题（"无效的访问令牌"）
- **常见原因**：
  - 用户未登录或登录已过期
  - 服务器重启后token失效
  - 浏览器缓存问题
  - 数据库连接问题
- **快速解决方案**：
  1. 运行 `quick_fix_auth.bat` 快速修复
  2. 使用页面上的"清除缓存"按钮（个人中心）
  3. 手动清除浏览器localStorage
  4. 重新登录获取新token
- **详细诊断**：
  - 运行 `fix_auth.bat` 进行详细诊断
  - 运行 `debug_auth.js` 查看具体问题
- **预防措施**：
  - 定期重新登录
  - 保持MySQL服务稳定运行
  - 避免频繁重启服务器

### 8. 注册验证失败
- **用户名**：必须是3-50个字符
- **密码**：至少6个字符
- **邮箱**：必须是有效的邮箱格式（如：user@example.com）
- **手机号**：必须是11位手机号（如：13800138000）
- 确保所有字段都填写完整

### 9. 登录失败
- 确认使用正确的测试账号（英文用户名）
- 密码是：password123
- 用户名可以是：zhangsan、lisi、wangwu、zhaoliu
- 或者使用对应的邮箱地址登录

### 10. 端口占用问题（已修复）
- **自动解决**：系统会自动检测端口占用并选择可用端口
- **用户提示**：会显示实际使用的端口号
- **手动解决**：可以关闭占用端口的程序，或使用系统自动选择的端口
- **范围限制**：系统会在3000-3100范围内查找可用端口

## 🧪 测试脚本

如果遇到问题，可以运行测试脚本检查环境：

```bash
# Windows
.\test.bat

# Linux/Mac
chmod +x test.sh
./test.sh
```

## 📞 技术支持

如遇到问题，请：
1. 查看控制台错误信息
2. 检查README.md文档
3. 运行测试脚本检查环境
4. 提交GitHub Issue

## 🔄 更新日志

### v2.5 (最新版本)
- ✅ 统一了密码输入方式，交互式输入也使用PowerShell隐藏显示
- ✅ 添加了密码输入安全提示，提醒用户注意环境安全
- ✅ 添加了端口自动检测和切换功能
- ✅ 解决了端口占用导致的启动失败问题
- ✅ 优化了用户提示信息，显示实际使用的端口
- ✅ 改进了错误处理和用户体验
- ✅ **重要修复**：解决了认证中间件连接池问题
- ✅ **新增功能**：自动处理token过期，提示用户重新登录
- ✅ **新增工具**：`fix_auth.bat` 认证问题诊断工具

### v2.4
- ✅ 修复了测试账号问题，使用英文用户名
- ✅ 更新了数据库初始化脚本，使用加密密码
- ✅ 改进了注册验证规则说明
- ✅ 优化了测试账号信息展示
- ✅ 添加了详细的注册要求说明

### v2.3
- ✅ 修复了交互式密码输入后API调用失败的问题
- ✅ 实现了连接池动态更新机制
- ✅ 所有路由都使用最新的数据库连接池
- ✅ 改进了数据库连接的错误处理
- ✅ 优化了资源管理，避免连接池泄漏

### v2.2
- ✅ 优化了浏览器打开机制
- ✅ 只在数据库连接成功后打开浏览器
- ✅ 避免在连接失败时显示错误页面
- ✅ 添加了跨平台浏览器打开支持
- ✅ 改进了用户体验和错误处理

### v2.1
- ✅ 添加了交互式密码输入功能
- ✅ 当数据库连接失败时自动提示输入密码
- ✅ 支持无密码MySQL配置
- ✅ 改进了错误处理和用户提示
- ✅ 优化了密码处理机制

### v2.0
- ✅ 修复了批处理文件的中文编码问题
- ✅ 使用英文界面，提高兼容性
- ✅ 改进了错误处理和用户提示
- ✅ 添加了测试脚本
- ✅ 优化了启动流程

### v1.0
- ✅ 基础的一键启动功能
- ✅ 数据库自动初始化
- ✅ 密码安全处理

## 💡 使用技巧

### 密码管理
1. **首次使用**：建议在启动脚本中输入密码
2. **日常使用**：如果密码正确，系统会直接连接
3. **密码错误**：系统会自动提示重新输入
4. **无密码配置**：直接按回车即可

### 浏览器管理
1. **连接成功**：浏览器会自动打开
2. **连接失败**：浏览器不会打开，避免错误页面
3. **手动访问**：可以手动访问 http://localhost:3000
4. **跨平台**：支持Windows、Mac、Linux自动打开

### 用户管理
1. **测试账号**：使用提供的4个测试账号
2. **注册新用户**：按照验证规则填写信息
3. **登录方式**：支持用户名或邮箱登录
4. **密码安全**：所有密码都经过加密存储

### 故障排除
1. **连接失败**：检查MySQL服务状态
2. **密码错误**：使用交互式输入功能
3. **权限问题**：确认MySQL用户权限
4. **端口占用**：检查3000端口是否被占用
5. **浏览器问题**：检查默认浏览器设置
6. **API问题**：确认连接池已正确更新
7. **注册问题**：检查输入格式是否符合要求

---

**注意**: 这是一个教学演示项目，请勿在生产环境中直接使用。 